"""
consumers/user_consumer.py - ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸

ì´ íŒŒì¼ì—ì„œ ë°°ìš¸ ìˆ˜ ìˆëŠ” ê°œë…ë“¤:
1. Kafka Consumer íŒ¨í„´
2. ì´ë²¤íŠ¸ ê¸°ë°˜ ì²˜ë¦¬ (Event-Driven Processing)
3. ì—ëŸ¬ ì²˜ë¦¬ì™€ ì¬ì‹œë„ ë¡œì§
4. ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ì‹±
5. ë¡œê¹…ê³¼ ëª¨ë‹ˆí„°ë§
6. graceful shutdown ì²˜ë¦¬
"""

import asyncio
import signal
import sys
import json
import logging
from typing import Dict, Any
from datetime import datetime
from kafka import KafkaConsumer
from kafka.errors import KafkaError
from services.kafka_service import kafka_service
from services.redis_service import redis_service
from models import EventType
import time


# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('consumer.log'),  # ë¡œê·¸ íŒŒì¼ì— ì €ì¥
        logging.StreamHandler(sys.stdout)      # ì½˜ì†”ì—ë„ ì¶œë ¥
    ]
)
logger = logging.getLogger(__name__)


class UserEventConsumer:
    """
    ì‚¬ìš©ì ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ Kafka Consumer í´ë˜ìŠ¤
    
    ì‚¬ìš©ì ê´€ë ¨ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
    - ì´ë²¤íŠ¸ ìˆ˜ì‹  ë° íŒŒì‹±
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
    - ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì‹œë„
    - ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    """
    
    def __init__(self, group_id: str = "user_event_processor"):
        """
        ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸ ì´ˆê¸°í™”
        
        Args:
            group_id (str): ì»¨ìŠˆë¨¸ ê·¸ë£¹ ID
        """
        self.group_id = group_id
        self.consumer = None
        self.running = False
        self.processed_count = 0
        self.error_count = 0
        self.start_time = datetime.now()
        
        # ì²˜ë¦¬í•  í† í”½ ëª©ë¡
        self.topics = ['user_events']
        
        # ì´ë²¤íŠ¸ ì²˜ë¦¬ê¸° ë§¤í•‘
        self.event_handlers = {
            EventType.USER_CREATED: self._handle_user_created,
            EventType.USER_UPDATED: self._handle_user_updated,
            EventType.USER_DELETED: self._handle_user_deleted,
            EventType.USER_LOGIN: self._handle_user_login,
            EventType.USER_LOGOUT: self._handle_user_logout
        }
        
        logger.info(f"âœ… ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸ ì´ˆê¸°í™” ì™„ë£Œ (ê·¸ë£¹: {group_id})")
    
    def create_consumer(self) -> KafkaConsumer:
        """
        Kafka Consumer ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        
        Returns:
            KafkaConsumer: êµ¬ì„±ëœ ì»¨ìŠˆë¨¸ ì¸ìŠ¤í„´ìŠ¤
        """
        try:
            consumer = kafka_service.create_consumer(
                topics=self.topics,
                group_id=self.group_id,
                auto_offset_reset='earliest'  # ì²˜ìŒë¶€í„° ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬
            )
            
            logger.info(f"ğŸ”„ Kafka Consumer ìƒì„±: {self.topics} (ê·¸ë£¹: {self.group_id})")
            return consumer
            
        except Exception as e:\n            logger.error(f\"âŒ Kafka Consumer ìƒì„± ì‹¤íŒ¨: {e}\")\n            raise\n    \n    async def start(self):\n        \"\"\"\n        ì»¨ìŠˆë¨¸ ì‹œì‘\n        \n        ë©”ì¸ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ì‹œì‘í•˜ê³  ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.\n        Graceful shutdownì„ ìœ„í•œ ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ë„ ì„¤ì •í•©ë‹ˆë‹¤.\n        \"\"\"\n        try:\n            # ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ì„¤ì • (Ctrl+C ì²˜ë¦¬)\n            signal.signal(signal.SIGINT, self._signal_handler)\n            signal.signal(signal.SIGTERM, self._signal_handler)\n            \n            # Consumer ìƒì„±\n            self.consumer = self.create_consumer()\n            self.running = True\n            \n            logger.info(\"ğŸš€ ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸ ì‹œì‘\")\n            logger.info(f\"ğŸ“‹ êµ¬ë… í† í”½: {self.topics}\")\n            logger.info(f\"ğŸ‘¥ ì»¨ìŠˆë¨¸ ê·¸ë£¹: {self.group_id}\")\n            \n            # ë©”ì¸ ì²˜ë¦¬ ë£¨í”„\n            await self._process_messages()\n            \n        except KeyboardInterrupt:\n            logger.info(\"â¹ï¸ ì‚¬ìš©ì ì¤‘ë‹¨ ì‹ í˜¸ ìˆ˜ì‹ \")\n        except Exception as e:\n            logger.error(f\"âŒ ì»¨ìŠˆë¨¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n        finally:\n            await self._shutdown()\n    \n    async def _process_messages(self):\n        \"\"\"\n        ë©”ì‹œì§€ ì²˜ë¦¬ ë©”ì¸ ë£¨í”„\n        \n        Kafkaì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³  ì ì ˆí•œ í•¸ë“¤ëŸ¬ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.\n        \"\"\"\n        logger.info(\"ğŸ”„ ë©”ì‹œì§€ ì²˜ë¦¬ ë£¨í”„ ì‹œì‘\")\n        \n        try:\n            # ë©”ì‹œì§€ í´ë§ ë° ì²˜ë¦¬\n            for message in self.consumer:\n                if not self.running:\n                    logger.info(\"â¹ï¸ ì»¨ìŠˆë¨¸ ì¤‘ë‹¨ í”Œë˜ê·¸ í™•ì¸ë¨\")\n                    break\n                \n                try:\n                    # ë©”ì‹œì§€ ì²˜ë¦¬\n                    await self._handle_message(message)\n                    \n                    # í†µê³„ ì—…ë°ì´íŠ¸\n                    self.processed_count += 1\n                    \n                    # ì£¼ê¸°ì ìœ¼ë¡œ í†µê³„ ì¶œë ¥ (100ê°œë§ˆë‹¤)\n                    if self.processed_count % 100 == 0:\n                        await self._log_stats()\n                    \n                except Exception as e:\n                    logger.error(f\"âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n                    self.error_count += 1\n                    \n                    # ì—ëŸ¬ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì ì‹œ ëŒ€ê¸°\n                    if self.error_count > 10:\n                        logger.warning(\"âš ï¸ ì—ëŸ¬ê°€ ë§ì´ ë°œìƒí•˜ì—¬ 5ì´ˆ ëŒ€ê¸°\")\n                        await asyncio.sleep(5)\n                        self.error_count = 0  # ì—ëŸ¬ ì¹´ìš´íŠ¸ ë¦¬ì…‹\n        \n        except Exception as e:\n            logger.error(f\"âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ë£¨í”„ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_message(self, message):\n        \"\"\"\n        ê°œë³„ ë©”ì‹œì§€ ì²˜ë¦¬\n        \n        Args:\n            message: Kafka ë©”ì‹œì§€\n        \"\"\"\n        try:\n            # ë©”ì‹œì§€ ì •ë³´ ë¡œê¹…\n            logger.info(\n                f\"ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ : {message.topic} \"\n                f\"(íŒŒí‹°ì…˜: {message.partition}, ì˜¤í”„ì…‹: {message.offset})\"\n            )\n            \n            # ë©”ì‹œì§€ ë°ì´í„° íŒŒì‹±\n            event_data = message.value\n            event_type = event_data.get('event_type')\n            user_id = event_data.get('user_id')\n            \n            # ë©”ì‹œì§€ ê²€ì¦\n            if not event_type:\n                logger.warning(f\"âš ï¸ ì´ë²¤íŠ¸ íƒ€ì…ì´ ì—†ëŠ” ë©”ì‹œì§€: {message.offset}\")\n                return\n            \n            # í—¤ë” ì •ë³´ ì¶”ì¶œ (ìˆëŠ” ê²½ìš°)\n            headers = dict(message.headers) if message.headers else {}\n            \n            # ì²˜ë¦¬ ì‹œì‘ ë¡œê·¸\n            logger.info(f\"ğŸ”„ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œì‘: {event_type} (ì‚¬ìš©ì: {user_id})\")\n            \n            # ì ì ˆí•œ í•¸ë“¤ëŸ¬ ì°¾ê¸° ë° ì‹¤í–‰\n            handler = self.event_handlers.get(event_type)\n            \n            if handler:\n                await handler(event_data, headers)\n                logger.info(f\"âœ… ì´ë²¤íŠ¸ ì²˜ë¦¬ ì™„ë£Œ: {event_type} (ì‚¬ìš©ì: {user_id})\")\n            else:\n                logger.warning(f\"âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ íƒ€ì…: {event_type}\")\n                await self._handle_unknown_event(event_data)\n        \n        except json.JSONDecodeError as e:\n            logger.error(f\"âŒ JSON íŒŒì‹± ì˜¤ë¥˜: {e}\")\n        except Exception as e:\n            logger.error(f\"âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    # ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤\n    \n    async def _handle_user_created(self, event_data: Dict[str, Any], headers: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \n        ì‚¬ìš©ìê°€ ìƒˆë¡œ ìƒì„±ë˜ì—ˆì„ ë•Œì˜ í›„ì† ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤:\n        - í™˜ì˜ ì´ë©”ì¼ ë°œì†¡\n        - ì´ˆê¸° ì„¤ì • ìƒì„±\n        - ë¡œê·¸ ê¸°ë¡\n        \"\"\"\n        try:\n            user_id = event_data.get('user_id')\n            user_data = event_data.get('data', {})\n            \n            logger.info(f\"ğŸ‘¤ ìƒˆ ì‚¬ìš©ì ìƒì„± ì²˜ë¦¬: {user_id}\")\n            \n            # 1. í™˜ì˜ ë©”ì‹œì§€ë¥¼ ìºì‹œì— ì €ì¥ (ì˜ˆì‹œ)\n            welcome_message = {\n                \"message\": f\"{user_data.get('name', 'ì‚¬ìš©ì')}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!\",\n                \"created_at\": datetime.now().isoformat(),\n                \"read\": False\n            }\n            \n            cache_key = f\"welcome_message:{user_id}\"\n            await redis_service.set_cache(cache_key, welcome_message, expire=86400)  # 24ì‹œê°„\n            \n            # 2. ì‚¬ìš©ì ìƒì„± ë¡œê·¸ ê¸°ë¡\n            await self._log_user_activity(\n                user_id=user_id,\n                activity=\"user_created\",\n                details=user_data\n            )\n            \n            # 3. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì´ë©”ì¼ ì„œë¹„ìŠ¤ í˜¸ì¶œ\n            await self._send_welcome_email(user_data.get('email'), user_data.get('name'))\n            \n            logger.info(f\"âœ… ì‚¬ìš©ì ìƒì„± í›„ì† ì²˜ë¦¬ ì™„ë£Œ: {user_id}\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì ìƒì„± ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_user_updated(self, event_data: Dict[str, Any], headers: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \"\"\"\n        try:\n            user_id = event_data.get('user_id')\n            changed_fields = event_data.get('data', {}).get('changed_fields', [])\n            \n            logger.info(f\"ğŸ”„ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ì²˜ë¦¬: {user_id} (ë³€ê²½: {changed_fields})\")\n            \n            # ì¤‘ìš”í•œ í•„ë“œ ë³€ê²½ ì‹œ ì¶”ê°€ ì²˜ë¦¬\n            if 'email' in changed_fields:\n                # ì´ë©”ì¼ ë³€ê²½ ì‹œ ì¸ì¦ ì´ë©”ì¼ ë°œì†¡\n                logger.info(f\"ğŸ“§ ì´ë©”ì¼ ë³€ê²½ ê°ì§€: {user_id} - ì¸ì¦ ì´ë©”ì¼ ë°œì†¡ í•„ìš”\")\n                # await self._send_email_verification(user_id)\n            \n            if 'status' in changed_fields:\n                # ìƒíƒœ ë³€ê²½ ì‹œ ì•Œë¦¼\n                logger.info(f\"ğŸ”” ì‚¬ìš©ì ìƒíƒœ ë³€ê²½: {user_id}\")\n            \n            # ì‚¬ìš©ì ìˆ˜ì • ë¡œê·¸ ê¸°ë¡\n            await self._log_user_activity(\n                user_id=user_id,\n                activity=\"user_updated\",\n                details={\"changed_fields\": changed_fields}\n            )\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì ìˆ˜ì • ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_user_deleted(self, event_data: Dict[str, Any], headers: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì ì‚­ì œ ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \"\"\"\n        try:\n            user_id = event_data.get('user_id')\n            \n            logger.info(f\"ğŸ—‘ï¸ ì‚¬ìš©ì ì‚­ì œ ì²˜ë¦¬: {user_id}\")\n            \n            # 1. ê´€ë ¨ ìºì‹œ ë°ì´í„° ì‚­ì œ\n            await redis_service.delete_user_cache(user_id)\n            await redis_service.delete_cache(f\"welcome_message:{user_id}\")\n            \n            # 2. ì‚¬ìš©ì í™œë™ ë¡œê·¸ì— ì‚­ì œ ê¸°ë¡\n            await self._log_user_activity(\n                user_id=user_id,\n                activity=\"user_deleted\",\n                details={\"deleted_at\": datetime.now().isoformat()}\n            )\n            \n            # 3. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ê´€ë ¨ ë°ì´í„° ì •ë¦¬\n            # - ì‚¬ìš©ì íŒŒì¼ ì‚­ì œ\n            # - ê´€ë ¨ ì„œë¹„ìŠ¤ ì•Œë¦¼\n            # - ë°ì´í„° ë³´ì¡´ ì •ì±… ì ìš©\n            \n            logger.info(f\"âœ… ì‚¬ìš©ì ì‚­ì œ í›„ì† ì²˜ë¦¬ ì™„ë£Œ: {user_id}\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì ì‚­ì œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_user_login(self, event_data: Dict[str, Any], headers: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \"\"\"\n        try:\n            user_id = event_data.get('user_id')\n            login_data = event_data.get('data', {})\n            \n            logger.info(f\"ğŸ” ì‚¬ìš©ì ë¡œê·¸ì¸ ì²˜ë¦¬: {user_id}\")\n            \n            # 1. ë¡œê·¸ì¸ í†µê³„ ì—…ë°ì´íŠ¸\n            today = datetime.now().strftime('%Y-%m-%d')\n            login_stats_key = f\"login_stats:{today}\"\n            \n            # Redisì—ì„œ ì¼ì¼ ë¡œê·¸ì¸ ìˆ˜ ì¦ê°€\n            try:\n                current_count = await redis_service.get_cache(login_stats_key) or 0\n                await redis_service.set_cache(\n                    login_stats_key, \n                    int(current_count) + 1, \n                    expire=86400  # 24ì‹œê°„\n                )\n            except Exception as e:\n                logger.warning(f\"âš ï¸ ë¡œê·¸ì¸ í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}\")\n            \n            # 2. ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì €ì¥\n            last_login_key = f\"last_login:{user_id}\"\n            await redis_service.set_cache(\n                last_login_key,\n                {\n                    \"login_time\": login_data.get('login_at'),\n                    \"login_count\": login_data.get('login_count', 1)\n                },\n                expire=2592000  # 30ì¼\n            )\n            \n            # 3. ë¡œê·¸ì¸ í™œë™ ê¸°ë¡\n            await self._log_user_activity(\n                user_id=user_id,\n                activity=\"user_login\",\n                details=login_data\n            )\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_user_logout(self, event_data: Dict[str, Any], headers: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \"\"\"\n        try:\n            user_id = event_data.get('user_id')\n            \n            logger.info(f\"ğŸ”“ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬: {user_id}\")\n            \n            # ë¡œê·¸ì•„ì›ƒ í™œë™ ê¸°ë¡\n            await self._log_user_activity(\n                user_id=user_id,\n                activity=\"user_logout\",\n                details=event_data.get('data', {})\n            )\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}\")\n            raise\n    \n    async def _handle_unknown_event(self, event_data: Dict[str, Any]):\n        \"\"\"\n        ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ ì²˜ë¦¬\n        \"\"\"\n        try:\n            logger.warning(f\"â“ ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸: {event_data.get('event_type')}\")\n            \n            # ë¯¸ì²˜ë¦¬ ì´ë²¤íŠ¸ë¥¼ ë³„ë„ ì €ì¥ì†Œì— ê¸°ë¡ (ë¶„ì„ìš©)\n            unknown_event_key = f\"unknown_events:{datetime.now().strftime('%Y-%m-%d')}\"\n            \n            # ê¸°ì¡´ ë¯¸ì²˜ë¦¬ ì´ë²¤íŠ¸ ëª©ë¡ ì¡°íšŒ\n            unknown_events = await redis_service.get_cache(unknown_event_key) or []\n            \n            # ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€\n            unknown_events.append({\n                \"event_data\": event_data,\n                \"timestamp\": datetime.now().isoformat()\n            })\n            \n            # ì €ì¥ (í•˜ë£¨ ë³´ê´€)\n            await redis_service.set_cache(unknown_event_key, unknown_events, expire=86400)\n            \n        except Exception as e:\n            logger.error(f\"âŒ ë¯¸ì²˜ë¦¬ ì´ë²¤íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜: {e}\")\n    \n    # ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë“¤\n    \n    async def _log_user_activity(self, user_id: int, activity: str, details: Dict[str, Any]):\n        \"\"\"\n        ì‚¬ìš©ì í™œë™ ë¡œê·¸ ê¸°ë¡\n        \n        ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ë¡œê¹… ì‹œìŠ¤í…œì— ì €ì¥í•©ë‹ˆë‹¤.\n        \"\"\"\n        try:\n            activity_log = {\n                \"user_id\": user_id,\n                \"activity\": activity,\n                \"details\": details,\n                \"timestamp\": datetime.now().isoformat()\n            }\n            \n            # Redisì— ìµœê·¼ í™œë™ ì €ì¥ (ì˜ˆì‹œ)\n            activity_key = f\"user_activities:{user_id}\"\n            recent_activities = await redis_service.get_cache(activity_key) or []\n            \n            # ìµœê·¼ 10ê°œ í™œë™ë§Œ ìœ ì§€\n            recent_activities.append(activity_log)\n            if len(recent_activities) > 10:\n                recent_activities = recent_activities[-10:]\n            \n            await redis_service.set_cache(activity_key, recent_activities, expire=604800)  # 7ì¼\n            \n            logger.info(f\"ğŸ“ ì‚¬ìš©ì í™œë™ ë¡œê·¸ ê¸°ë¡: {user_id} - {activity}\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì‚¬ìš©ì í™œë™ ë¡œê·¸ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜: {e}\")\n    \n    async def _send_welcome_email(self, email: str, name: str):\n        \"\"\"\n        í™˜ì˜ ì´ë©”ì¼ ë°œì†¡ (ì‹œë®¬ë ˆì´ì…˜)\n        \n        ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì´ë©”ì¼ ì„œë¹„ìŠ¤ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.\n        \"\"\"\n        try:\n            logger.info(f\"ğŸ“§ í™˜ì˜ ì´ë©”ì¼ ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜: {email} ({name})\")\n            \n            # ì‹¤ì œë¡œëŠ” SendGrid, AWS SES ë“±ì˜ ì´ë©”ì¼ ì„œë¹„ìŠ¤ ì‚¬ìš©\n            # await email_service.send_welcome_email(email, name)\n            \n            # ì´ë©”ì¼ ë°œì†¡ ë¡œê·¸ë¥¼ Redisì— ì €ì¥\n            email_log = {\n                \"type\": \"welcome_email\",\n                \"recipient\": email,\n                \"name\": name,\n                \"sent_at\": datetime.now().isoformat(),\n                \"status\": \"sent\"\n            }\n            \n            email_log_key = f\"email_logs:{datetime.now().strftime('%Y-%m-%d')}\"\n            email_logs = await redis_service.get_cache(email_log_key) or []\n            email_logs.append(email_log)\n            \n            await redis_service.set_cache(email_log_key, email_logs, expire=86400)\n            \n        except Exception as e:\n            logger.error(f\"âŒ í™˜ì˜ ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜: {e}\")\n    \n    async def _log_stats(self):\n        \"\"\"\n        ì²˜ë¦¬ í†µê³„ ë¡œê·¸ ì¶œë ¥\n        \"\"\"\n        try:\n            uptime = datetime.now() - self.start_time\n            rate = self.processed_count / uptime.total_seconds() if uptime.total_seconds() > 0 else 0\n            \n            logger.info(\n                f\"ğŸ“Š ì²˜ë¦¬ í†µê³„: ì²˜ë¦¬ëœ ë©”ì‹œì§€ {self.processed_count}ê°œ, \"\n                f\"ì—ëŸ¬ {self.error_count}ê°œ, \"\n                f\"ì²˜ë¦¬ ì†ë„ {rate:.2f}ê°œ/ì´ˆ, \"\n                f\"ì‹¤í–‰ ì‹œê°„ {uptime}\"\n            )\n            \n        except Exception as e:\n            logger.error(f\"âŒ í†µê³„ ë¡œê·¸ ì¶œë ¥ ì¤‘ ì˜¤ë¥˜: {e}\")\n    \n    def _signal_handler(self, signum, frame):\n        \"\"\"\n        ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ (Graceful Shutdown)\n        \n        Ctrl+Cë‚˜ SIGTERM ì‹œê·¸ë„ì„ ë°›ìœ¼ë©´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•©ë‹ˆë‹¤.\n        \"\"\"\n        logger.info(f\"ğŸ›‘ ì¢…ë£Œ ì‹ í˜¸ ìˆ˜ì‹  (ì‹œê·¸ë„: {signum})\")\n        self.running = False\n    \n    async def _shutdown(self):\n        \"\"\"\n        ì»¨ìŠˆë¨¸ ì•ˆì „ ì¢…ë£Œ\n        \n        ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•˜ê³  í†µê³„ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.\n        \"\"\"\n        try:\n            logger.info(\"ğŸ”„ ì»¨ìŠˆë¨¸ ì¢…ë£Œ ì¤‘...\")\n            \n            if self.consumer:\n                self.consumer.close()\n                logger.info(\"âœ… Kafka Consumer ì—°ê²° ì¢…ë£Œ\")\n            \n            # ìµœì¢… í†µê³„ ì¶œë ¥\n            await self._log_stats()\n            \n            logger.info(\"âœ… ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸ ì¢…ë£Œ ì™„ë£Œ\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ ì»¨ìŠˆë¨¸ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜: {e}\")\n\n\n# ì»¨ìŠˆë¨¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì‹¤í–‰\nasync def main():\n    \"\"\"\n    ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜\n    \n    ì»¨ìŠˆë¨¸ë¥¼ ìƒì„±í•˜ê³  ì‹œì‘í•©ë‹ˆë‹¤.\n    \"\"\"\n    try:\n        # ì»¨ìŠˆë¨¸ ìƒì„±\n        consumer = UserEventConsumer(group_id=\"user_event_processor\")\n        \n        # ì»¨ìŠˆë¨¸ ì‹œì‘\n        await consumer.start()\n        \n    except KeyboardInterrupt:\n        logger.info(\"â¹ï¸ ì‚¬ìš©ì ì¤‘ë‹¨\")\n    except Exception as e:\n        logger.error(f\"âŒ ë©”ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}\")\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    \"\"\"\n    ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰ ì‹œ ì»¨ìŠˆë¨¸ ì‹œì‘\n    \n    ì‚¬ìš©ë²•:\n        python consumers/user_consumer.py\n    \n    ë˜ëŠ” ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰:\n        python consumers/user_consumer.py &\n    \"\"\"\n    logger.info(\"ğŸš€ ì‚¬ìš©ì ì´ë²¤íŠ¸ ì»¨ìŠˆë¨¸ ì‹œì‘\")\n    \n    try:\n        # ì´ë²¤íŠ¸ ë£¨í”„ ì‹¤í–‰\n        asyncio.run(main())\n    except KeyboardInterrupt:\n        logger.info(\"â¹ï¸ ì»¨ìŠˆë¨¸ ì¢…ë£Œ\")\n    except Exception as e:\n        logger.error(f\"âŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}\")\n        sys.exit(1)"